<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CSP for Android WebView -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SecureVault</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Crypto & EmailJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        primaryDark: '#2563eb',
                        sidebar: '#1e293b',
                        danger: '#ef4444',
                        dangerDark: '#dc2626'
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .mobile-bottom-nav { padding-bottom: env(safe-area-inset-bottom); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 h-screen w-screen overflow-hidden flex flex-col">

    <!-- 1. AUTH WRAPPER -->
    <div id="auth-wrapper" class="view-section active w-full h-full flex items-center justify-center bg-blue-50 relative p-4">
        
        <!-- A. SETUP (First Time) -->
        <div id="card-setup" class="hidden bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm fade-in border border-blue-100">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-shield-heart text-2xl text-primary"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800">Setup SecureVault</h1>
                <p class="text-slate-500 text-xs mt-1">Create your master key & recovery email.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 uppercase">Master Password</label>
                    <input type="password" id="setup-pass" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-primary focus:bg-white outline-none transition" placeholder="Create strong password">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 uppercase">Confirm Password</label>
                    <input type="password" id="setup-pass-confirm" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-primary focus:bg-white outline-none transition" placeholder="Repeat password">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 uppercase">Recovery Email</label>
                    <input type="email" id="setup-email" class="w-full p-3 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-primary focus:bg-white outline-none transition" placeholder="you@example.com">
                </div>
                
                <!-- Hidden Recovery Key Area -->
                <div id="setup-recovery-display" class="hidden bg-yellow-50 border border-yellow-100 rounded-xl p-4 text-center animate-slide-up">
                    <p class="text-xs font-bold text-yellow-700 mb-2 flex items-center justify-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> SAVE THIS KEY!</p>
                    <p class="font-mono text-xs bg-white p-2 rounded border border-yellow-200 break-all select-all text-slate-600" id="recovery-key-text"></p>
                    <button id="btn-finish-setup" class="mt-3 w-full py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-xs font-bold transition">I Have Saved It</button>
                </div>

                <button id="btn-start-setup" class="w-full py-3 bg-primary hover:bg-primaryDark text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition mt-2">
                    Create Vault
                </button>
            </div>
        </div>

        <!-- B. LOGIN -->
        <div id="card-login" class="hidden bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm fade-in text-center border border-blue-100">
            <div class="mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <i class="fa-solid fa-lock text-2xl text-white"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800">Unlock Vault</h1>
                <p class="text-slate-500 text-xs mt-2">Enter your master password.</p>
            </div>
            
            <div class="space-y-3 text-left">
                <div class="relative">
                     <input type="password" id="login-pass" class="w-full p-3 pr-10 rounded-xl border border-slate-200 bg-slate-50 focus:ring-2 focus:ring-primary outline-none transition" placeholder="Master Password">
                     <i class="fa-regular fa-eye absolute right-3 top-3.5 text-slate-400 cursor-pointer hover:text-primary" onclick="togglePass('login-pass')"></i>
                </div>
                
                <button id="btn-unlock" class="w-full py-3 bg-primary hover:bg-primaryDark text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition">
                    Unlock
                </button>
                
                <button id="btn-use-recovery" class="w-full py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-key text-xs"></i> Use Recovery Key
                </button>
                
                <button class="text-xs text-slate-400 hover:text-primary mt-4 w-full" onclick="alert('Decoy Vault: Opens a fake vault with dummy data to protect you under duress.')">Open Decoy Vault</button>
            </div>
        </div>

        <!-- C. OTP (2FA) -->
        <div id="card-otp" class="hidden bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm fade-in text-center border border-purple-100">
            <div class="mb-4">
                <div class="bg-purple-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-envelope-open-text text-2xl text-purple-600"></i>
                </div>
                <h1 class="text-lg font-bold text-slate-800">Verify Identity</h1>
                <p class="text-slate-500 text-xs mt-1">Code sent to <span id="otp-email-display" class="font-bold text-slate-700"></span></p>
            </div>
            <div class="space-y-4">
                <input type="text" id="otp-input" class="w-full p-3 text-center text-3xl font-mono tracking-[0.5em] rounded-xl border border-slate-200 focus:ring-2 focus:ring-purple-500 outline-none transition" placeholder="000000" maxlength="6">
                <button id="btn-verify-otp" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition">Verify Code</button>
                <div class="flex justify-between text-xs px-2">
                    <button onclick="showAuthCard('card-login')" class="text-slate-400 hover:text-slate-600">Back</button>
                    <button onclick="resendOTP()" class="text-purple-600 font-bold hover:underline">Resend Code</button>
                </div>
            </div>
        </div>

        <!-- D. RECOVERY -->
        <div id="card-recovery" class="hidden bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm fade-in border border-red-100">
            <h1 class="text-xl font-bold text-red-600 mb-2 text-center"><i class="fa-solid fa-life-ring mr-2"></i>Recovery</h1>
            <p class="text-slate-500 text-xs text-center mb-4">Use your saved key to reset access.</p>
            
            <div class="mb-4">
                <textarea id="recovery-key-input" class="w-full p-3 h-24 text-xs border border-slate-200 rounded-xl mt-1 font-mono focus:ring-2 focus:ring-red-500 outline-none resize-none" placeholder="Paste your 32-character recovery key here..."></textarea>
                <button id="btn-do-recover" class="w-full py-2.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl mt-2 text-sm shadow-lg shadow-red-200 transition">Recover Account</button>
            </div>
            
            <button onclick="showAuthCard('card-login')" class="w-full text-center text-xs text-slate-400 hover:text-slate-600">Cancel</button>
        </div>
    </div>

    <!-- 2. DASHBOARD -->
    <div id="dashboard-wrapper" class="view-section hidden flex-col h-full bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white px-4 py-3 border-b border-slate-100 flex justify-between items-center shadow-sm shrink-0 z-10">
            <div class="flex items-center gap-2">
                <div class="bg-blue-50 p-2 rounded-lg"><i class="fa-solid fa-shield-halved text-primary"></i></div>
                <h1 class="font-bold text-slate-700 tracking-tight">SecureVault</h1>
            </div>
            <button onclick="openModal('modal-item')" class="bg-slate-900 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg hover:bg-slate-700 transition active:scale-95">
                <i class="fa-solid fa-plus"></i>
            </button>
        </header>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
            
            <!-- VIEW: VAULT -->
            <div id="subview-vault" class="subview active">
                <div class="relative mb-4">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                    <input type="text" id="search-bar" class="w-full pl-10 p-3 rounded-xl border-none bg-white shadow-sm text-sm placeholder-slate-400 outline-none focus:ring-2 focus:ring-primary/20 transition" placeholder="Search passwords...">
                </div>
                <div id="vault-grid" class="space-y-3"></div>
            </div>

            <!-- VIEW: GENERATOR -->
            <div id="subview-generator" class="subview">
                <h2 class="font-bold text-lg mb-4 text-slate-700">Generator</h2>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="bg-slate-50 p-4 rounded-xl flex justify-between items-center mb-6 border border-slate-200 border-dashed">
                        <span id="gen-display" class="font-mono text-lg break-all tracking-wider text-slate-700 font-bold">Generating...</span>
                        <button onclick="copyText(document.getElementById('gen-display').innerText)" class="active:scale-90 transition"><i class="fa-regular fa-copy text-primary text-xl"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-xs font-bold text-slate-400 uppercase mb-2">Length: <span id="len-val" class="text-primary">16</span></label>
                            <input type="range" min="8" max="32" value="16" class="w-full accent-primary cursor-pointer" oninput="updateGenUI(this.value)">
                        </div>
                        <button class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-blue-200 active:scale-[0.98] transition" onclick="updateGenUI()">
                            <i class="fa-solid fa-rotate mr-2"></i> Regenerate
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="subview-settings" class="subview">
                <h2 class="font-bold text-lg mb-4 text-slate-700">Settings</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                    <!-- 2FA Toggle -->
                    <div class="p-4 border-b border-slate-50 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-700 text-sm">Two-Factor Auth</h3>
                            <p class="text-xs text-slate-400">Email OTP on login</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="setting-2fa-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                    
                    <!-- NEW: Master Email Setting -->
                    <div class="p-4 border-b border-slate-50">
                        <h3 class="font-bold text-slate-700 text-sm mb-1">Recovery Email</h3>
                        <div class="flex gap-2">
                            <input type="email" id="settings-email" class="w-full p-2 text-xs bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-primary/20" placeholder="Set Master Email">
                            <button onclick="saveSettingsEmail()" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-3 rounded-lg transition">Save</button>
                        </div>
                    </div>

                    <!-- Lock Vault -->
                    <button onclick="location.reload()" class="w-full text-left p-4 text-slate-600 text-sm font-bold hover:bg-slate-50 transition">
                        <i class="fa-solid fa-lock mr-2"></i> Lock Vault Now
                    </button>
                </div>

                <!-- DANGER ZONE -->
                <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                    <h3 class="text-danger font-bold text-sm mb-2 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</h3>
                    <p class="text-[10px] text-red-400 mb-3 leading-relaxed">Changing your master password will <b>invalidate your old Recovery Key</b>. You will be issued a new one immediately.</p>
                    <button onclick="openModal('modal-change-pass')" class="w-full py-2.5 bg-white border border-red-200 text-danger font-bold rounded-xl text-xs hover:bg-red-50 transition shadow-sm">
                        Change Master Password
                    </button>
                </div>
                
                <p class="text-center text-[10px] text-slate-300 mt-8">SecureVault v1.2 â€¢ Group 50</p>
            </div>

        </div>

        <!-- Bottom Nav -->
        <nav class="bg-white border-t border-slate-100 fixed bottom-0 w-full flex justify-around py-3 pb-6 mobile-bottom-nav z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <button onclick="switchTab('subview-vault', this)" class="nav-btn active flex flex-col items-center gap-1 text-slate-400 w-16 transition">
                <i class="fa-solid fa-wallet text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">Vault</span>
            </button>
            <button onclick="switchTab('subview-generator', this)" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-16 transition">
                <i class="fa-solid fa-key text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">Gen</span>
            </button>
            <button onclick="switchTab('subview-settings', this)" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-16 transition">
                <i class="fa-solid fa-gear text-xl mb-0.5"></i>
                <span class="text-[10px] font-bold">Settings</span>
            </button>
        </nav>
    </div>

    <!-- 3. MODALS -->
    
    <!-- Add Password Modal -->
    <div id="modal-item" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">New Password</h3>
                <button onclick="closeModal('modal-item')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <input type="text" id="modal-site" class="w-full p-3 rounded-xl bg-slate-50 border-none focus:ring-2 focus:ring-primary/20 outline-none" placeholder="Website Name">
                <input type="text" id="modal-user" class="w-full p-3 rounded-xl bg-slate-50 border-none focus:ring-2 focus:ring-primary/20 outline-none" placeholder="Username / Email">
                <div class="flex gap-2">
                    <input type="text" id="modal-pass" class="w-full p-3 rounded-xl bg-slate-50 border-none focus:ring-2 focus:ring-primary/20 outline-none font-mono text-sm" placeholder="Password">
                    <button onclick="document.getElementById('modal-pass').value = generateRandom()" class="bg-slate-100 w-12 rounded-xl hover:bg-slate-200"><i class="fa-solid fa-arrows-rotate text-slate-500"></i></button>
                </div>
            </div>
            <button id="btn-save" class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-lg mt-6">Save Entry</button>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="modal-change-pass" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-danger">Change Master Key</h3>
                <button onclick="closeModal('modal-change-pass')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <input type="password" id="cp-old" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-danger/20 outline-none" placeholder="Current Password">
                <input type="password" id="cp-new" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-danger/20 outline-none" placeholder="New Password">
                <input type="password" id="cp-confirm" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-danger/20 outline-none" placeholder="Confirm New Password">
            </div>
            <button onclick="changeMasterPassword()" class="w-full py-3 bg-danger hover:bg-dangerDark text-white font-bold rounded-xl shadow-lg mt-6">Update Password</button>
        </div>
    </div>

    <!-- New Recovery Key Modal -->
    <div id="modal-new-rec" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl border-2 border-yellow-400 text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-key text-3xl text-yellow-600"></i>
            </div>
            <h3 class="font-bold text-xl text-slate-800">New Recovery Key</h3>
            <p class="text-sm text-slate-500 mt-2 mb-4">Your old key is destroyed. Save this new one!</p>
            <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-200 mb-6">
                <p class="font-mono text-sm break-all text-slate-700 select-all" id="new-rec-key-display"></p>
            </div>
            <button onclick="location.reload()" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-lg">I Saved It, Reload App</button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script src="js/app.js"></script>
</body>
</html>